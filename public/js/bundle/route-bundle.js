!function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(){this.ZOOM_LEVEL_BASE=.000246153846,this.ZOOM_LEVEL_STEP=.4514682741,this.MAX_GROUP_LEVEL=4,this._svg=SVG("map"),this._svg.attr("version","1.1"),this._svg.attr("role","graphics-document document"),this._zoomlevel=3,this._container="#map svg ",this.guides_drawn=!1,this.marker_groups=Array.apply(null,Array(20)).map(function(e){return[]}),this.auto_marker_groups=Array.apply(null,Array(20)).map(function(e){return[]}),this.auto_grouped_buildings=[]}return Object.defineProperty(e,"instance",{get:function(){return this._instance||(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"svg",{get:function(){return this._svg},set:function(e){this._svg=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoomlevel",{get:function(){return this._zoomlevel},set:function(e){this._zoomlevel=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"container",{get:function(){return this._container},set:function(e){this._container=e},enumerable:!0,configurable:!0}),e.prototype.fetchData=function(){var e=this;if(void 0===this._data){var t=Cookies.get("locationRadio")||100;return $.getJSON("/map/data/"+t,function(e){return e})}new Promise(function(t,n){t(e._data)})},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"guidesDrawn",{get:function(){return this.guides_drawn},set:function(e){this.guides_drawn=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullw",{get:function(){return this.svg.viewbox().width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullh",{get:function(){return this.svg.viewbox().height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDrawn",{set:function(e){this.onmapdrawn=e},enumerable:!0,configurable:!0}),e.prototype.drawGuides=function(){if(!(this.zoomlevel>=this.MAX_GROUP_LEVEL)){$(this.container+".jails").remove();for(var e=this.svg.group().addClass("jails").back(),t=this.zoomlevel,n=100/t+"%",a=this.svg.viewbox(),o=a.x,r=a.y,i=this.fullw/t,s=this.fullh/t,c=0;c<t;c++)for(var l=0;l<t;l++)e.rect(n,n).move(o+c*i,r+l*s).fill("transparent").stroke({width:0})}},e.prototype.calculateAutoGroups=function(){if(!(this.zoomlevel>=this.MAX_GROUP_LEVEL)){this.drawGuides();for(var e=0,t=this.svg.select(".jails rect").members;e<t.length;e++){for(var n=t[e],a=!1,o=0;o<this.data.groups[this.zoomlevel].length;o++){var r=this.data.groups[this.zoomlevel][o];if(n.inside(r.lat,r.long)){a=!0;break}}if(!a){var i=0,s=void 0;for(o=0;o<this.data.buildings.length;o++){var c=this.data.buildings[o],l=c.centerx,u=c.centery;n.inside(l,u)&&-1==c.groups.indexOf(this.zoomlevel)&&(i++,-1==this.marker_groups[this.zoomlevel].indexOf(parseInt(c.properties.id.value))&&this.marker_groups[this.zoomlevel].push(parseInt(c.properties.id.value)),(void 0==s||parseInt(c.properties.priority.value)<parseInt(s.properties.priority.value))&&(s=c))}0!=i&&this.data.groups[this.zoomlevel].push({id:parseInt(s.centerx).toString()+parseInt(s.centery).toString(),affects:i,lat:s.centerx,long:s.centery,name:"Marcadores cerca de "+s.properties.name.value,radius:n.width()/2,auto:!0})}}}},e.prototype.draw=function(){var e=this;this.fetchData().then(function(t){e.data=t,e.svg.attr("id","this.svg_MAIN"),e.svg.attr("preserveAspectRatio","xMidYMid slice"),e.svg.attr("class","map-dragable"),e.svg.attr("tabindex",0);for(var n=e.svg.group().attr("id","SVG_MAIN_CONTENT").front(),a=function(t){var a=n.group().link("#feature-"+t.properties.id.value).attr("class","non-link building-wrapper feature-object").attr("id","link-feature-"+t.properties.id.value);a.attr("data-building",t.properties.id.value),a.attr("role","graphics-symbol img"),a.attr("data-name",t.properties.name.value),a.attr("data-coords",t.centerx+":"+t.centery),a.attr("data-description",t.properties.description.value),a.attr("data-nearest",t.nearestnames.reduce(function(e,t){return e+","+t})),a.attr("data-nearest-radius",t.nearestnamesradius);var o=a.path().attr("d",t.path);o.attr("id","feature-shape-"+t.properties.id.value),o.attr("class","building");var r=a.group().attr("id","marker-"+t.properties.id.value).attr("class","map-marker"),i=r.image("/images/building_marker.svg",14,14);i.attr("class","marker"),i.attr("x",t.centerx-15),i.attr("y",t.centery-7);var s=r.text(function(e){for(var n=t.properties.name.value.split(" "),a=[n[0]],o=1;o<n.length;o++){var r=n[o];a[a.length-1].length+r.length<=10||null!=r.match(/^(,|.|;|:|")$/i)?a[a.length-1]+=" "+r:a.push(r)}for(o=0;o<a.length;o++)0==o?e.tspan(a[o]):e.tspan(a[o]).move(t.centerx,t.centery).dy(5*o)});s.attr("text-anchor","start"),s.attr("id","label-"+(t.properties.id?t.properties.id.value:"")),s.attr("x",t.centerx),s.attr("y",t.centery),s.font({weight:"bold"}),a.attr("aria-labelledby","label-"+t.properties.id.value);for(var c=0,l=t.groups;c<l.length;c++){var u=l[c];e.marker_groups[u].push(t.properties.id.value)}},o=0,r=e.data.buildings;o<r.length;o++){a(r[o])}e.onmapdrawn()})},e.prototype.drawLocation=function(e,t){console.log("Location update",e,t);var n=$(this.container+"#locationg");if(0==n.length){var a=this.svg.select("#SVG_MAIN_CONTENT").members[0].group().front();a.attr("id","locationg");var o=a.circle().radius(10);o.cx(e).cy(t),o.fill("deeppink")}else n.find("circle").attr("cx",e),n.find("circle").attr("cy",t)},e.prototype.drawOrientation=function(t,n,a){var o=$(this.container+"#orientationg");if(0==o.length){var r=this.svg.select("#SVG_MAIN_CONTENT").members[0].group().front();r.attr("id","orientationg");var i=r.image("/images/arrow.svg");i.move(t-8,n-24),i.attr("width",16),i.attr("height",16)}else o.find("image").attr("x",t-8),o.find("image").attr("y",n-24);var s=a<0?a+360:a;$(e.instance.container+"#orientationg image").css({"transform-origin":t+"px "+n+"px",transform:"rotateZ("+(270-s)+"deg)"}),o.attr("data-orientation",270-s),o.attr("data-x",t),o.attr("data-y",n)},e.prototype.groupMarkers=function(e){var t=0;this.calculateAutoGroups();for(var n=[],a=0,o=this.marker_groups;a<o.length;a++){for(var r=0,i=o[a];r<i.length;r++){var s=i[r];t==e?n.push(s):($("#link-feature-"+s).removeAttr("tabindex"),$("#link-feature-"+s).removeClass("non-clickable"),this.svg.select("#marker-"+s).show())}for(var c=0,l=this.data.groups[t];c<l.length;c++){var u=l[c];if(t==e){var d=1==u.affects.toString().length?1:u.affects.toString().length/2,p=this.svg.select("#SVG_MAIN_CONTENT").members[0].link("#gmarker-"+u.id).attr("class","non-link gmarker").attr("id","gmarker-"+u.id);p.attr("data-name",u.name);var v=p.group(),h=v.circle().radius(10);h.cx(u.lat).cy(u.long);var f=v.plain(u.affects).attr("text-anchor","middle");f.font({size:16/d}),f.move(u.lat,u.long-8/d),p.title(u.name).attr("id","gmarker-"+u.id+"-title"),p.attr("aria-labelledby","gmarker-"+u.id+"-title"),p.attr("data-coords",h.cx()+":"+h.cy()),f.attr("aria-hidden","true"),f.attr("role","presentation")}else for(var g=0,m=this.svg.select("#gmarker-"+u.id).members;g<m.length;g++){m[g].remove()}}t++}for(var b=0,y=n;b<y.length;b++){s=y[b];this.svg.select("#marker-"+s).hide(),$("#link-feature-"+s).attr("tabindex","-1"),$("#link-feature-"+s).addClass("non-clickable")}var w=this;$(this.container+"a.gmarker").on("focus",function(){$(this).on("keyup",function(e){if(13==e.which){e.preventDefault(),w.zoomlevel+=2;var t=$(this).attr("data-coords").split(":"),n=t[0],a=t[1];w.zoomAndMove(n,a,w.zoomlevel)}})}),$(this.container+"a.gmarker").on("click",function(e){e.preventDefault(),w.zoomlevel+=2;var t=$(this).attr("data-coords").split(":"),n=t[0],a=t[1];w.zoomAndMove(n,a,w.zoomlevel)}),this.updateSidebar()},e.prototype.isInview=function(t){var n=e.instance.svg.viewbox().x,a=e.instance.svg.viewbox().y,o=n+e.instance.svg.viewbox().width,r=a+e.instance.svg.viewbox().height,i=$(t).attr("data-coords"),s=parseFloat(i.split(":")[0]),c=parseFloat(i.split(":")[1]);return s>=n&&s<=o&&(c>=a&&c<=r)},e.prototype.updateSidebar=function(){var e=this;$("#currentViewPanel ul").empty(),this.zoomlevel<this.MAX_GROUP_LEVEL?$(this.container+".gmarker").each(function(t,n){var a=e.isInview(n);if($(n).attr("data-inview",String(a)),a){var o=$(n).attr("data-name"),r=$(n).attr("data-coords").split(":")[0],i=$(n).attr("data-coords").split(":")[1],s=document.createElement("li"),c=document.createElement("a");$(c).html("Grupo: "+o),$(c).attr("href","#"),$(c).attr("data-type","group"),$(c).attr("data-listened",String(!1)),$(c).attr("data-x",r),$(c).attr("data-y",i),$(s).append(c),$("#currentViewPanel ul").append(s)}}):$(this.container+"a.feature-object").each(function(t,n){var a=e.isInview(n);if($(e).attr("data-inview",String(a)),a){var o=$(n).attr("data-coords"),r=parseFloat(o.split(":")[0]),i=parseFloat(o.split(":")[1]),s=document.createElement("li"),c=document.createElement("a");$(c).html("Edificio: "+$(n).attr("data-name")),$(c).attr("href","#"),$(c).attr("data-id",$(n).attr("data-id")),$(c).attr("data-x",r),$(c).attr("data-y",i),$(s).append(c),$("#currentViewPanel ul").append(s)}})},e.prototype.getZoomValues=function(e,t){var n=$("#map").width();return{vbx:n/=this.ZOOM_LEVEL_BASE+(e-1)*this.ZOOM_LEVEL_STEP,wdiff:t?(this.svg.viewbox().width-n)/2:0}},e.prototype.resizeToLevel=function(e,t){var n=this;if(void 0===t&&(t=!0),!(e<2||e>21)){$(this.container+".jails").remove(),this.zoomlevel=e;var a=this.getZoomValues(e,t),o=a.vbx,r=a.wdiff;(t?this.svg.animate({duration:250}):this.svg).viewbox(this.svg.viewbox().x+r,this.svg.viewbox().y+r,o,o),window.location.href="#zoom="+e,setTimeout(function(){n.groupMarkers(e),n.updateSidebar()},400)}},e.prototype.move=function(e,t,n){var a=this;void 0===n&&(n=!0),(n?this.svg.animate({duration:250}):this.svg).viewbox(this.svg.viewbox().x+e,this.svg.viewbox().y+t,this.svg.viewbox().width,this.svg.viewbox().height),setTimeout(function(){a.updateSidebar()},400)},e.prototype.moveTo=function(e,t,n){var a=this;void 0===n&&(n=!0),(n?this.svg.animate({duration:250}):this.svg).viewbox(e-this.fullw/2,t-this.fullh/2,this.svg.viewbox().width,this.svg.viewbox().height),setTimeout(function(){a.updateSidebar()},400)},e.prototype.zoomAndMove=function(e,t,n,a){var o=this;void 0===a&&(a=!0),$(this.container+".jails").remove(),this.zoomlevel=n;var r=this.getZoomValues(n,!0),i=r.vbx,s=r.wdiff;(a?this.svg.animate({duration:250}):this.svg).viewbox(e-this.fullw/2+s,t-this.fullh/2+s,i,i),window.location.href="#zoom="+n,setTimeout(function(){o.groupMarkers(n),o.updateSidebar()},400)},e}();t.SVGMap=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),o=n(2),r=n(3),i=function(){function e(){this.voice=new o.SVGVoiceControls,proj4.defs("EPSG:25830","+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs")}return Object.defineProperty(e,"instance",{get:function(){return e._instance||(e._instance=new e),e._instance},enumerable:!0,configurable:!0}),e.prototype.pageLoad=function(){a.SVGMap.instance.onDrawn=function(){setTimeout(function(){a.SVGMap.instance.groupMarkers(a.SVGMap.instance.zoomlevel)},100);var e=null,t=new r.SVGLocation;t.watch(function(t,n){var o=proj4("EPSG:4326","EPSG:25830",[n,t]),r=o[0],i=o[1];e={x:r,y:-i},a.SVGMap.instance.drawLocation(r,-i)}),t.watchOrientation(function(t,n,o){null!=e&&a.SVGMap.instance.drawOrientation(e.x,e.y,t)}),a.SVGMap.instance.updateSidebar()},a.SVGMap.instance.draw()},Object.defineProperty(e.prototype,"voiceControl",{get:function(){return this.voice},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onSearchVoiceQuery",{get:function(){return this.searchResultCallback},set:function(e){this.searchResultCallback=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onSearchResultSelected",{get:function(){return this.searchResultSelected},set:function(e){this.searchResultSelected=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRouteCommand",{get:function(){return this.routeCommand},set:function(e){this.routeCommand=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onUnknownVoiceCommand",{get:function(){return this.uvc},set:function(e){this.uvc=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"searchResultsForVoiceSelection",{get:function(){return this.srfvs},set:function(e){this.srfvs=e},enumerable:!0,configurable:!0}),e.prototype.startVoice=function(){var e=this;o.SVGVoiceControls.compatible()&&(o.SVGVoiceControls.setOn(!0),this.voice.start(function(t){var n=t.confidence,a=t.transcript;console.log("Voice received:"),console.log(n,a);var o=e.voice.parseAction(a);if(o)switch(console.log("Parsed as",o),o.name){case"unknown":return void e.onUnknownVoiceCommand();case"search":return void e.onSearchVoiceQuery(o.query);case"select":return void e.onSearchResultSelected(e.toDigit(o.item));case"route":return void e.onRouteCommand({origin:o.origin,target:o.target});case"access-routes":return void e.onRouteCommand(null);case"zoom":return void e.navigationHandler("acercar"===o.direction?"zoom-in":"zoom-out");default:return void e.navigationHandler(o.direction)}}))},e.prototype.stopVoice=function(){o.SVGVoiceControls.compatible()&&void 0!==this.voice&&(o.SVGVoiceControls.setOn(!1),this.voice.stop())},e.prototype.navigationHandler=function(e){var t=20-a.SVGMap.instance.zoomlevel+15,n=0,o=0;switch(e){case"up":o=-t;break;case"down":o=t;break;case"left":n=-t;break;case"right":n=t;break;case"zoom-in":return a.SVGMap.instance.zoomlevel=20==a.SVGMap.instance.zoomlevel?a.SVGMap.instance.zoomlevel:a.SVGMap.instance.zoomlevel+1,void a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel);case"zoom-out":return a.SVGMap.instance.zoomlevel=1==a.SVGMap.instance.zoomlevel?a.SVGMap.instance.zoomlevel:a.SVGMap.instance.zoomlevel-1,void a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel)}a.SVGMap.instance.move(n,o)},e.prototype.toDigit=function(e){var t=["uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve","diez"];console.log(t.length,e);for(var n=0;n<t.length;n++)if(t[n]==e)return n+1;return-1},e}();t.SVGControls=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(5),o=function(){function e(){this.time_per_word=500,e.compatible()&&(this.list=new webkitSpeechGrammarList,this.list.addFromString(""),this.voice=new webkitSpeechRecognition,this.voice.lang="es-ES",this.voice.interimResults=!1,this.voice.maxAlternatives=1,this.voice.grammars=this.list,this.voice.continuous=!0),this.container=document.getElementById("speech")}return e.compatible=function(){return"undefined"!=typeof SpeechRecognition||"undefined"!=typeof webkitSpeechRecognition},e.isOn=function(){return this.on},e.setOn=function(e){this.on=e},e.prototype.say=function(t){var n=this,a=e.isOn();e.setOn(!1),this.stop(),this.container.innerHTML="",this.container.innerHTML=t,setTimeout(function(){e.setOn(a),n.start(n.onTranscript)},this.time_per_word*t.split(" ").length)},e.prototype.start=function(t){var n=this;if(console.log(e.isOn()),e.isOn()){this.onTranscript=t,this.voice.onresult=function(e){n.voice.stop();var a=e.results.length-1,o=e.results[a][0].transcript,r=e.results[a][0].confidence;r>=.75?t({confidence:r,transcript:o}):(console.log("Ignoring because of low confidence:"),console.log("("+r+") "+o))},this.voice.onend=function(){var n=this;console.log("Voice end and on="+e.isOn()),e.isOn()&&setTimeout(function(){n.start(t)},1e3)};try{this.voice.start()}catch(e){}console.log("Voice started...")}},e.prototype.stop=function(){this.voice.stop()},e.prototype.parseAction=function(e){var t=a.voiceParse(e);if(console.log(t),"move"==t.name)switch(t.direction){case"la derecha":t.direction="right";break;case"la izquierda":t.direction="left";break;case"arriba":t.direction="up";break;case"abajo":t.direction="down";break;default:t.direction=null}else if("zoom"===t.action)switch(t.direction){case"alejar":t.direction="zoom-out";break;case"acercar":t.direction="zoom-in";break;default:t.direction=null}return t},e.on=!1,e}();t.SVGVoiceControls=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(){this.orientationAccum=0}return e.prototype.isGeolocationAvailable=function(){return"geolocation"in navigator},e.prototype.watch=function(e){this.isGeolocationAvailable()&&navigator.geolocation.watchPosition(function(t){e(t.coords.latitude,t.coords.longitude)},function(e){console.log("[LOCATION WATCH] error",e)},{enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3})},e.prototype.getCurrentPosition=function(e){navigator.geolocation.getCurrentPosition(function(t){e(t.coords.latitude,t.coords.longitude)},function(e){console.log("[LOCATION GET] error",e)},{enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3})},e.prototype.watchOrientation=function(e){var t=this;window.addEventListener("deviceorientation",function(n){50==t.orientationAccum?(t.orientationAccum=0,e(n.alpha,n.beta,n.gamma)):t.orientationAccum++})},e}();t.SVGLocation=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),o=n(1);$(document).ready(function(){window.gsvg=a.SVGMap.instance.svg,o.SVGControls.instance.pageLoad(),a.SVGMap.instance.moveTo(717444.93870502,-4251399.25399798);var e=!1;$("body").not("input").not("textarea").keydown(function(t){if(e=e||18==t.which){var n="";switch(t.which){case 189:case 171:n="zoom-out";break;case 187:case 173:n="zoom-in";break;case 38:n="up";break;case 40:n="down";break;case 37:n="left";break;case 39:n="right"}o.SVGControls.instance.navigationHandler(n)}}),$("body").not("input").not("textarea").keyup(function(t){18==t.which&&(e=!1)});var t,n,r=!1,i=!1,s="ontouchstart"in window?"touchmove":"mousemove",c="ontouchstart"in window?"touchend":"mouseup",l="ontouchstart"in window?"touchstart":"mousedown",u=$(a.SVGMap.instance.container).get(0).getScreenCTM();console.log(u),$(a.SVGMap.instance.container).on(l,function(e){e.preventDefault(),r=!("ontouchstart"in window)||1==e.touches.length,t="ontouchstart"in window?e.targetTouches[0].pageX:e.pageX,n="ontouchstart"in window?e.targetTouches[0].pageY:e.pageY}),$(a.SVGMap.instance.container).on(c,function(e){i&&a.SVGMap.instance.groupMarkers(a.SVGMap.instance.zoomlevel),r=!1}),$(a.SVGMap.instance.container).on(s,function(e){if(r){var o="ontouchstart"in window?e.targetTouches[0].pageX:e.pageX,s="ontouchstart"in window?e.targetTouches[0].pageY:e.pageY,c=(o-t)/-35,l=(s-n)/-35;a.SVGMap.instance.move(c,l,!1),i=!0}});var d,p=!1;$(a.SVGMap.instance.container).on("mousewheel DOMMouseScroll",function(e){if(e.preventDefault(),!p){var t="number"==typeof e.originalEvent.detail&&0!==e.originalEvent.detail?e.originalEvent.detail:e.originalEvent.wheelDelta;console.log("wheel",t),t>0?a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel+1,!0):a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel-1,!0),p=!0,setTimeout(function(){return p=!1},400)}});var v=!1;$(a.SVGMap.instance.container).on("touchstart",function(e){2==e.touches.length&&(v=!0,d=Math.abs(e.touches[0].pageX-e.touches[1].pageX))}),$(a.SVGMap.instance.container).not("a").on("touchmove",function(e){(e.preventDefault(),v&&!p&&2==e.touches.length)&&(Math.abs(e.touches[0].pageX-e.touches[1].pageX)>d?(a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel+1,!0),p=!0):(a.SVGMap.instance.resizeToLevel(a.SVGMap.instance.zoomlevel-1,!0),p=!0),setTimeout(function(){return p=!1},400))})})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=[{name:"antiloop",pattern:/(No te he entendido)|(El mapa está ahora escuchando)/i,extract:[]},{name:"move",pattern:/(mover) (mapa |mapas |plano )?(a |hacia |para )?(la derecha|la izquierda|arriba|abajo)/i,extract:[{name:"direction",position:4}]},{name:"zoom",pattern:/(alejar|acercar)( mapa)?/i,extract:[{name:"direction",position:1}]},{name:"search",pattern:/(buscar) ([\w | \d]+)+/i,extract:[{name:"query",position:2}]},{name:"select",pattern:/(seleccionar |elegir |escoger |ver )(número |resultado )*(\w+)+/i,extract:[{name:"item",position:3}]},{name:"access-routes",pattern:/i((acceder a)|(acceso a)|(ir a)) (((cálculo de)|(calcular)|(calculo de))+ )*(ruta)/i,extract:[]},{name:"route",pattern:/((ir )|(calcular ruta ))*desde ((\w|\d| )+) hasta ((\w|\d| )+)/i,extract:[{name:"origin",position:4},{name:"target",position:6}]}];t.voiceParse=function(e){for(var t=0,n=a;t<n.length;t++){var o=n[t],r=e.match(o.pattern);if(null!=r){for(var i={name:o.name},s=0,c=o.extract;s<c.length;s++){var l=c[s];i[l.name]=r[l.position]}return i}}return{name:"unknown"}}},function(e,t,n){"use strict";function a(e){return e*Math.PI/180}function o(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))}Object.defineProperty(t,"__esModule",{value:!0}),t.angulo=function(e,t){var n=e.x,a=t.y,r={x:n-e.x,y:a-e.y},i={x:n-t.x,y:a-t.y};return t.x,e.x,t.y,e.y,Math.atan2(o(i),o(r))},t.perspectiva=function(e,t){var n=e.y-t.y,a=e.x-t.x;return console.log("perspectiva",a,n),Math.abs(n)>Math.abs(a)?n>0?180:0:a>0?270:90},t.toDeg=function(e){return 180*e/Math.PI},t.toRad=a,t.modulo=o,t.rotar=function(e,t,n,o,r){var i=a(r);r=parseFloat(r);var s=Math.sin(i),c=Math.cos(i),l=e-n,u=t-o;return[l*c-u*s+n,l*s+u*c+o]}},,,,function(e,t,n){n(4),e.exports=n(11)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(6),o=n(0),r=n(12),i=n(3),s="fas fa-times red";function c(e,t){e.find("button i").attr("class",t)}$(document).ready(function(){loadSettings();var e,t,n,l=[!1,!1];$("#routeSource, #routeTarget").on("keypress",function(e){"Tab"!=e.originalEvent.code&&($(this).parent().find("button").removeClass("btn-primary btn-success btn-danger"),c($(this).parent(),"fas fa-search"))}),$(".routeBtn").on("click",function(a){if(a.preventDefault(),n="#"+$(this).attr("data-search"),c($(n),"fas fa-spinner rotating-spinner"),$(n).find("button").removeClass("btn-primary btn-success btn-danger"),$(n).find("button").addClass("btn-primary"),""==$(n).find("input").val())return c($(n),s),$(n).find("button").removeClass("btn-primary btn-success btn-danger"),void $(n).find("button").addClass("btn-danger");$.getJSON("/map/data/s/name/"+$(n).find("input").val(),function(a){if(200==a.code){var o=a.results;if(0==o.length)$(n).find("button").removeClass("btn-primary btn-success btn-danger"),$(n).find("button").addClass("btn-danger"),c($(n),s);else if(1==o.length)$(n).find("input").val(o[0].name),c($(n),"fas fa-check green"),$(n).find("button").removeClass("btn-primary btn-success btn-danger"),$(n).find("button").addClass("btn-success"),"#sourceForm"==n?(l[0]=!0,e=o[0].id):(l[1]=!0,t=o[0].id);else{var r="#sourceForm"==n?"Punto de origen":"Punto de destino";$("#searchModal .modal-body").empty(),$("#modalTitle").html(r);for(var i=0,u=o;i<u.length;i++){var d=u[i];console.log(d);var p=document.createElement("div"),v=document.createElement("input");$(v).attr("type","radio"),$(v).attr("data-feature",d.name),$(v).attr("aria-label","Elegir "+d.name+" como "+r),$(v).attr("name","featureSelection"),$(v).attr("id","feature-"+d.id),$(v).attr("value",d.name),$(v).attr("tabindex",0);var h=document.createElement("label");$(h).attr("for","feature-"+d.id),$(h).html(d.name),$(p).attr("class","check-group"),$(p).append(v),$(p).append(h),console.log(p),$("#searchModal .modal-body").append(p)}$("#searchModal").modal("show")}}})}),$("#searchModal").on("shown.bs.modal",function(e){$('#searchModal input[name="featureSelection"]:first').trigger("focus")}),$("#searchModal").on("hide.bs.modal",function(a){var o=$('#searchModal input[name="featureSelection"]:checked').val();if(void 0===o)c($(n),s),$(n).find("button").removeClass("btn-primary btn-success btn-danger"),$(n).find("button").addClass("btn-danger");else{var r=$('#searchModal input[name="featureSelection"]:checked').attr("id").split("feature-")[1];$(n).find("input").val(o),c($(n),"fas fa-check green"),$(n).find("button").removeClass("btn-primary btn-success btn-danger"),$(n).find("button").addClass("btn-success"),"#sourceForm"==n?(l[0]=!0,e=r):(l[1]=!0,t=r)}}),$("#calculateBtn").on("click",function(n){n.preventDefault();for(var a=!0,o=0,i=l;o<i.length;o++){var s=i[o];a=a&&s}console.log(a,e,t),a&&$.getJSON("/map/data/pi/"+e+","+t+","+$("#impairmentSelect").val(),function(e){console.log("path",e),r.navigationMode(e.data),0!=$("#impairmentSelect").val()&&0==e.disability?($("#nonAccessibleWarning").css("display","block"),$("#nonAccessibleWarning").html($("#nonAccessibleWarning").html())):$("#nonAccessibleWarning").css("display","none")})}),$(".focus-location button").on("click",function(e){e.preventDefault(),(new i.SVGLocation).getCurrentPosition(function(e,t){var n=proj4("EPSG:4326","EPSG:25830",[t,e]),a=n[0],r=n[1];o.SVGMap.instance.moveTo(a,-r)})}),$(".focus-orientation button").on("click",function(e){e.preventDefault(),$(".route-orientation:first-child").trigger("focus")});var u=150;new MutationObserver(function(e){for(var t=function(e){if("attributes"===e.type){var t=e.target;if("orientationg"===$(t).attr("id")){var n=$(t).attr("data-orientation"),r=parseFloat($(t).attr("data-x")),i=parseFloat($(t).attr("data-y")),s=$("#orientationLine");if(0==s.length){var c=o.SVGMap.instance.svg.line(r,i,r,i).stroke({width:0}).fill("black");c.attr("id","orientationLine"),c.front()}else{var l=a.rotar(r,i-300,r,i,n),d=l[0],p=l[1];s.attr("x1",r),s.attr("x2",d),s.attr("y1",i),s.attr("y2",p)}if(150===u){console.log("Orientando..."),u=0;for(var v=parseFloat(s.attr("x2")),h=(parseFloat(s.attr("y2"))-i)/(v-r),f=function(e){return h*e-h*r+i},g=r;g<=r+150;g++){for(var m=f(g),b=null,y=0,w=o.SVGMap.instance.svg.select(".feature-object").members;y<w.length;y++){var x=w[y];if(x.inside(g,m)){b=x;break}}if(null!=b){console.log("Orientado a",b),$(".route-steps .route-orientation").remove();var S=document.createElement("div"),M=document.createElement("span"),V="<span class='sr-only'>Información sobre tu orientación.</span>\n                                    Estás mirando hacia "+$(b.node).attr("data-name")+".\n                                ";$(M).html(V),$(S).append(M),$(S).addClass("route-step route-orientation"),$(S).attr("role","listitem"),$(S).attr("tabindex","0"),$(S).attr("data-step",-1),$(".route-steps").prepend(S)}}}u++}}},n=0,r=e;n<r.length;n++){t(r[n])}}).observe($(o.SVGMap.instance.container).get(0),{attributes:!0,childList:!1,subtree:!0})})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(6),o=n(0),r=[];t.navigationMode=function(e){$("#SVG_MAIN_CONTENT #route").empty();var t={x:e[0].vcenterx,y:e[0].vcentery},n={x:e[1].vcenterx,y:e[1].vcentery},i=a.perspectiva(n,t),s=i,c=a.toDeg(a.angulo(n,t));90==i&&(c=90-c),270==i&&(c=90-c),$("#map svg #SVG_MAIN_CONTENT").css({"transform-origin":t.x+"px "+t.y+"px",transform:"rotateX(-45deg) rotateZ("+(i+c)+"deg)"}),$("#map svg #SVG_MAIN_CONTENT .map-marker").each(function(e){$(this).css({"transform-origin":$(this).find("text").attr("x")+"px "+$(this).find("text").attr("y")+"px",transform:"rotateX(0deg) rotateZ(-"+(i+c)+"deg)"})});var l=-1;r=[];for(var u=0;u<e.length;u++){if(console.log("i",u,e[u],e[u+1]),u+1==e.length){r.push(e[u]),r[r.length-1].direction=-1,r[r.length-1].distance=a.modulo({x:t.x-r[r.length-1].vcenterx,y:t.y-r[r.length-1].vcentery});break}t={x:e[u].vcenterx,y:e[u].vcentery},n={x:e[u+1].vcenterx,y:e[u+1].vcentery},i=a.perspectiva(n,t),c=a.toDeg(a.angulo(n,t)),90==i&&(c=90-c),270==i&&(c=90-c);var d=i-l,p=0;0==d?p=0:90==d?p=1:-90==d&&(p=2);var v=0;if(null!=e[u].iid&&e[u].iid.length>0)for(var h=0;h<e[u].iid.length;h++){var f={x:e[u].icenterx[h],y:e[u].icentery[h]},g=a.perspectiva(f,t),m=g-l;if(c=a.toDeg(a.angulo(f,t)),90==g&&(c=90-c),270==g&&(c=90-c),console.log("poia",c),!(c>20)){if(90==m){r.push(e[u]),r[r.length-1].direction=p,r[r.length-1].distance=a.modulo({x:n.x-t.x,y:n.y-t.y}),r[r.length-1].poi=!0,r[r.length-1].poidirection=1,r[r.length-1].poiname=e[u].iname[h],v++;break}if(-90==m){r.push(e[u]),r[r.length-1].direction=p,r[r.length-1].distance=a.modulo({x:n.x-t.x,y:n.y-t.y}),r[r.length-1].poi=!0,r[r.length-1].poidirection=2,r[r.length-1].poiname=e[u].iname[h],v++;break}}}if(i==l){var b=r.length-1;r[b].distance=r[b].distance+a.modulo({x:n.x-t.x,y:n.y-t.y})}else 0==v&&(r.push(e[u]),r[r.length-1].direction=p,r[r.length-1].distance=a.modulo({x:n.x-t.x,y:n.y-t.y}),r[r.length-1].poi=!1);l=i}var y=o.SVGMap.instance.svg.select("#SVG_MAIN_CONTENT").members[0].group().attr("id","route"),w=[],x=1;console.log("guide",r);for(var S=0,M=r;S<M.length;S++){var V=(E=M[S]).vcenterx,_=E.vcentery,k=y.circle().radius(5);k.cx(V),k.cy(_),k.fill("#1A237E"),k.attr("id","step-circle-"+x),w.push([V],[_]),x++}y.polyline(w).fill("transparent").stroke({width:3,color:"#1A237E"}).back(),$(".route-steps").empty();for(var G=1,O=0,z=r;O<z.length;O++){var E=z[O],T=document.createElement("div"),P=document.createElement("span"),C="<span class='sr-only'>Paso número "+G+".</span>";switch(1==E.poi&&(C+="Tienes "+E.poiname+" a la "+(1==E.poidirection?"izquierda":"derecha")+". "),E.direction){case 0:C+='Camina <span class="steps-expression" data-steps=\''+Math.ceil(E.distance)+"'>"+Math.ceil(E.distance)+" pasos</span> hacia delante";break;case 1:C+='Gira a la izquierda y camina <span class="steps-expression" data-steps=\''+Math.ceil(E.distance)+"'>"+Math.ceil(E.distance)+" pasos</span>";break;case 2:C+='Gira a la derecha y camina <span class="steps-expression" data-steps=\''+Math.ceil(E.distance)+"'>"+Math.ceil(E.distance)+" pasos</span>";break;case-1:C+="Has llegado a tu destino"}$(P).html(C),$(T).append(P),$(T).addClass("route-step"),$(T).attr("role","listitem"),$(T).attr("tabindex","0"),$(T).attr("data-step",G),$(T).attr("data-map-rotation",s),$(".route-steps").append(T),G++}$("#metricUnitSelect").on("change",function(e){$(".steps-expression").each(function(){var e=parseInt($(this).attr("data-steps"));if(0==$("#metricUnitSelect").val())$(this).html(e+" pasos");else{var t=e/2;$(this).html(t+" metros")}})}),$(".route-steps .route-step").on("focus",function(e){var t=r[parseInt($(this).attr("data-step"))-1];console.log("step data",t),$("#map svg #SVG_MAIN_CONTENT, .map-marker").css({"transform-origin":t.vcenterx+"px "+t.vcentery+"px"}),$("#map svg #SVG_MAIN_CONTENT .map-marker").each(function(e){$(this).css({"transform-origin":$(this).find("text").attr("x")+"px "+$(this).find("text").attr("y")+"px"})}),o.SVGMap.instance.zoomAndMove(t.vcenterx,t.vcentery,15,!1)}),$(".route-steps:not(.route-orientation) .route-step:first-child").trigger("focus"),$(".route-steps:not(.route-orientation) .route-step:first-child").trigger("focus")}}]);